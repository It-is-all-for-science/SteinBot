# SteinBot: История изменений и совместимость для деплоя на Render

## Основные изменения и решения проблем

1. **Проблемы с вебхуком и сервером**
   - Flask удалён, используется только встроенный сервер python-telegram-bot.
   - Путь вебхука скорректирован для соответствия требованиям Telegram.

2. **Логирование и диагностика**
   - Добавлены подробные print (с flush=True) для отслеживания этапов запуска и обработки сообщений.
   - В каждый хендлер добавлены try/except и логирование ошибок.

3. **Зависимости и их версии**
   - Возникла несовместимость с openai: код использует старый API, а на сервере ставилась новая версия (>=1.0.0).
   - Решение: явно указать openai==0.28.1 в requirements.txt (и поместить в конец файла).
   - langchain-huggingface обновлён до 0.3.0 для совместимости с PyPI.
   - Для обработки аудио добавлен pydub==0.25.1.

4. **Векторная база знаний (ChromaDB)**
   - При пустой или повреждённой базе бот зависал на создании HuggingFaceEmbeddings.
   - Временно отключали поиск по базе знаний для диагностики.
   - После этого бот отвечал стабильно.

5. **Асинхронность**
   - Все тяжёлые операции вынесены в run_in_executor для предотвращения блокировки event loop.

## Совместимые версии пакетов (на июнь 2024)

- python-telegram-bot==20.7
- openai==0.28.1
- langchain-huggingface==0.3.0
- pydub==0.25.1
- chromadb==0.4.22
- python-dotenv==1.0.1

> **Важно:**
> - Все зависимости должны быть явно указаны в requirements.txt.
> - Для работы с pydub на сервере Render может понадобиться ffmpeg (см. документацию Render по установке бинарников).

## Типичные ошибки и их решения

- **ModuleNotFoundError: No module named 'pydub'**
  - Решение: добавить pydub в requirements.txt
- **openai: AttributeError или несовместимость API**
  - Решение: использовать openai==0.28.1
- **Бот не отвечает, ошибки 404/502**
  - Проверить путь вебхука и логи запуска
- **Зависание на embeddings/Chroma**
  - Проверить целостность базы знаний, временно отключить поиск

---

Файл создан для внутреннего пользования SteinBot Team. Обновляйте при каждом важном изменении или появлении новых ошибок/решений. 